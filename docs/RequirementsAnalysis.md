# 要件分析（Requirements Analysis）

## 目的
研究室で使用する各種計測機器（主にSCPI対応機器）を統一的に制御・自動化し、測定データの取得・管理・出力を効率化する。

## 想定ユーザー
- 研究者・技術者（プラグイン開発者含む）
- 測定自動化スクリプトを作成・利用するユーザー

## 機能要件
### 1. コア機能
- VISA/シリアル通信による機器接続・切断・再接続
- SCPIコマンドの送信・応答取得
- コマンド送信後の完了確認（*OPC? など）
- エラーチェック（SYST:ERR? など）
- 共通SCPIコマンドセットの提供（リセット、ID取得、エラー取得等）
- 測定データの取得・保存（CSV/Excel/JSON等）
- ログ出力・操作履歴記録

### 2. プラグイン機能
- 機器ごとのSCPIコマンドラッパー作成が容易
- よく使うコマンドセットのテンプレート化
- プラグイン自動検出・動的ロード

### 3. スクリプト自動化
- 測定シーケンスの自動化・ステップ実行
- エラー発生時のリカバリ・通知
- 進捗・状態表示

## 非機能要件
- 拡張性（新規機器・コマンド追加が容易）
- 保守性（共通処理の抽象化、テスト容易性）
- ドキュメント整備（プラグイン開発ガイド等）

## 推奨ライブラリ
- pyvisa（VISA通信）
- pyserial（シリアル通信）
- numpy, pandas（データ処理・出力）
- loguru または logging（ログ出力）
- pytest（テスト）
- python-dotenv（設定管理、必要に応じて）

## ディレクトリ構成（例）
```
lab-instruments/
├── core/           # コア機能（通信・共通SCPI・出力）
├── plugins/        # 機器ごとのラッパー
├── scripts/        # 測定自動化スクリプト
├── docs/           # ドキュメント
└── ...             # その他管理ファイル
```

## 注意点・設計指針
- SCPIコマンド送信後は完了確認・エラーチェックを必ず行う
- プラグイン開発者が安全・簡単にラッパーを作れるよう、共通基底クラスで処理を抽象化
- 機器固有の癖や例外処理も考慮した設計

---

（本ファイルは今後の設計・実装・レビューの指針とする）

---

## core/serial.py 設計詳細

- 目的：シリアル通信（RS232/RS485等）による機器接続・SCPIコマンド送受信のためのクラスを提供
- 使用ライブラリ：pyserial

### クラス: SerialConnection
- `__init__(self, port, baudrate=9600, timeout=1)`
    - ポート名、ボーレート、タイムアウトを指定して初期化
- `connect(self)`
    - シリアルポートへ接続
- `disconnect(self)`
    - シリアルポートを切断
- `write(self, command)`
    - コマンドを送信（末尾に\n自動付与）
- `read(self)`
    - 1行受信しデコードして返す
- `query(self, command)`
    - コマンド送信→応答受信を1ステップで実行
- `is_connected(self)`
    - 接続状態をboolで返す

#### 使い方例
```python
conn = SerialConnection('/dev/ttyUSB0', baudrate=19200)
conn.connect()
conn.write('*IDN?')
response = conn.read()
conn.disconnect()
```

---

